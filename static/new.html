<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Polymarket Board</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:     #0d0d0d;
      --bg2:    #141414;
      --bg3:    #1a1a1a;
      --fg:     #e0e0e0;
      --dim:    #666;
      --accent: #00e5ff;
      --green:  #00c853;
      --red:    #ff1744;
      --border: #2a2a2a;
      --font:   'Cascadia Code', 'Fira Code', 'Courier New', monospace;
    }

    body {
      background: var(--bg);
      color: var(--fg);
      font-family: var(--font);
      font-size: 13px;
      line-height: 1.4;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── Header ──────────────────────────────────────────────────── */
    header {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 8px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--bg2);
      flex-shrink: 0;
    }

    .logo {
      font-size: 14px;
      font-weight: bold;
      color: var(--bg);
      background: var(--accent);
      padding: 2px 7px;
      letter-spacing: 1px;
      flex-shrink: 0;
    }

    .header-title {
      color: var(--fg);
      font-weight: bold;
      flex-shrink: 0;
    }

    .live-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--dim);
      display: inline-block;
      flex-shrink: 0;
    }
    .live-dot.active {
      background: var(--green);
      animation: pulse 1.8s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.3; }
    }

    .header-right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 14px;
      color: var(--dim);
      font-size: 11px;
    }

    #countdown { color: var(--accent); }
    #headerTs  { color: var(--dim); }

    /* ── Controls bar ────────────────────────────────────────────── */
    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--bg2);
      flex-shrink: 0;
      flex-wrap: wrap;
    }

    .ctrl-label {
      color: var(--dim);
      font-size: 11px;
      flex-shrink: 0;
    }

    #searchBox {
      background: var(--bg3);
      border: 1px solid var(--border);
      color: var(--fg);
      font-family: var(--font);
      font-size: 12px;
      padding: 3px 8px;
      width: 180px;
      outline: none;
    }
    #searchBox:focus { border-color: var(--accent); }

    #limitSel {
      background: var(--bg3);
      border: 1px solid var(--border);
      color: var(--fg);
      font-family: var(--font);
      font-size: 12px;
      padding: 3px 6px;
      outline: none;
      cursor: pointer;
    }

    .seg-group {
      display: flex;
      border: 1px solid var(--border);
    }
    .seg-btn {
      background: var(--bg3);
      border: none;
      border-right: 1px solid var(--border);
      color: var(--dim);
      font-family: var(--font);
      font-size: 12px;
      padding: 3px 9px;
      cursor: pointer;
      transition: background 0.1s, color 0.1s;
    }
    .seg-btn:last-child { border-right: none; }
    .seg-btn.active {
      background: var(--accent);
      color: var(--bg);
      font-weight: bold;
    }
    .seg-btn:not(.active):hover { background: var(--border); color: var(--fg); }

    #exportBtn {
      background: var(--bg3);
      border: 1px solid var(--border);
      color: var(--dim);
      font-family: var(--font);
      font-size: 11px;
      padding: 3px 9px;
      cursor: pointer;
      transition: border-color 0.1s, color 0.1s;
      margin-left: auto;
    }
    #exportBtn:hover { border-color: var(--accent); color: var(--fg); }

    #sortInfo {
      color: var(--dim);
      font-size: 11px;
      white-space: nowrap;
    }

    /* ── Table container ─────────────────────────────────────────── */
    .table-container {
      overflow: auto;
      flex: 1 1 auto;
    }

    table {
      border-collapse: collapse;
      white-space: nowrap;
      min-width: 700px;
      width: 100%;
    }

    thead th {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--bg);
      color: var(--accent);
      font-weight: bold;
      text-align: right;
      padding: 5px 8px;
      border-bottom: 2px solid var(--accent);
      font-size: 11px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      user-select: none;
    }
    thead th.left   { text-align: left; }
    thead th.sortable { cursor: pointer; }
    thead th.sortable:hover { color: var(--fg); }
    thead th.sorted { color: var(--fg); }

    tbody tr.data-row {
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.12s;
    }
    tbody tr.data-row:hover { background: var(--bg2); }
    tbody tr.data-row.open  { background: var(--bg2); }

    tbody tr.detail-row td {
      background: var(--bg3);
      border-bottom: 2px solid var(--accent);
      padding: 10px 14px;
    }

    tbody td {
      padding: 4px 8px;
      text-align: right;
      color: var(--fg);
      vertical-align: middle;
    }
    tbody td.left { text-align: left; }
    tbody td.rank {
      color: var(--dim);
      width: 28px;
      text-align: right;
    }

    /* scrollable event title cell */
    td.event-cell {
      text-align: left;
      max-width: 240px;
      overflow-x: auto;
      white-space: nowrap;
      font-weight: bold;
    }
    td.event-cell::-webkit-scrollbar { height: 6px; }
    td.event-cell::-webkit-scrollbar-track { background: #1c1c1c; }
    td.event-cell::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
    td.event-cell:hover::-webkit-scrollbar-thumb { background: #888; }

    .expand-icon {
      color: var(--dim);
      display: inline-block;
      font-size: 9px;
      transition: transform 0.18s;
      margin-right: 5px;
      vertical-align: middle;
    }
    .expand-icon.open { transform: rotate(90deg); }

    tbody td.vol    { color: var(--fg); }
    tbody td.vol24h { color: var(--dim); }

    td.cont-name {
      text-align: left;
      font-style: italic;
      color: #aaa;
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
      border-left: 1px solid #222;
      padding-left: 10px;
    }
    td.cont-price { font-weight: bold; }
    td.cont-delta { font-size: 12px; }

    td.up, .up   { color: var(--green); }
    td.down, .down { color: var(--red); }
    td.flat, .flat { color: var(--dim); }

    /* ── Detail row ──────────────────────────────────────────────── */
    .detail-content { padding: 2px 0 6px; }

    .detail-title {
      font-weight: bold;
      font-size: 13px;
      color: var(--fg);
      white-space: normal;
      word-break: break-word;
      margin-bottom: 4px;
    }

    .detail-meta {
      color: var(--dim);
      font-size: 11px;
      margin-bottom: 10px;
    }

    .detail-contenders {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 6px;
    }

    .detail-card {
      background: var(--bg);
      border: 1px solid var(--border);
      padding: 6px 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .detail-card-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-style: italic;
      color: #aaa;
    }

    .detail-card-price { font-weight: bold; flex-shrink: 0; }
    .detail-card-delta { font-size: 11px; flex-shrink: 0; width: 54px; text-align: right; }

    /* ── Empty / loading ─────────────────────────────────────────── */
    .empty {
      padding: 40px 18px;
      color: var(--dim);
      text-align: center;
    }

    /* ── Footer ──────────────────────────────────────────────────── */
    footer {
      padding: 5px 16px;
      color: var(--dim);
      font-size: 11px;
      border-top: 1px solid var(--border);
      background: var(--bg2);
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }
    footer .up   { color: var(--green); }
    footer .down { color: var(--red); }
    footer a {
      color: var(--accent);
      border: 1px solid var(--accent);
      padding: 2px 8px;
      text-decoration: none;
      font-size: 11px;
      letter-spacing: 0.5px;
      transition: background 0.15s, color 0.15s;
    }
    footer a:hover { background: var(--accent); color: var(--bg); }
    .footer-right { margin-left: auto; }
  </style>
</head>
<body>

<header>
  <span class="logo">POLYMARKET</span>
  <span class="header-title">Top Events</span>
  <span class="live-dot" id="liveDot"></span>
  <span id="liveLabel" style="color:var(--dim);font-size:11px">connecting…</span>
  <span class="header-right">
    <span id="countdown"></span>
    <span id="headerTs">—</span>
  </span>
</header>

<div class="controls">
  <span class="ctrl-label">search</span>
  <input id="searchBox" type="text" placeholder="filter events…" autocomplete="off" />

  <span class="ctrl-label">limit</span>
  <select id="limitSel">
    <option value="10">10</option>
    <option value="20" selected>20</option>
    <option value="50">50</option>
    <option value="100">100</option>
  </select>

  <span class="ctrl-label">contenders</span>
  <div class="seg-group" id="nGroup">
    <button class="seg-btn" data-n="1">1</button>
    <button class="seg-btn" data-n="2">2</button>
    <button class="seg-btn" data-n="3">3</button>
    <button class="seg-btn" data-n="4">4</button>
    <button class="seg-btn active" data-n="5">5</button>
  </div>

  <span id="sortInfo" style="display:none"></span>
  <button id="exportBtn">Export CSV</button>
</div>

<div class="table-container" id="tableContainer">
  <div class="empty" id="emptyMsg">Loading data…</div>
</div>

<footer>
  <span>Deltas:</span>
  <span class="up">▲ up</span>
  <span class="down">▼ down</span>
  <span>·</span>
  <span>Prices = probability in cents</span>
  <span class="footer-right"><a href="/">← classic</a></span>
</footer>

<script>
  // ── Escape HTML ─────────────────────────────────────────────────
  function esc(s) {
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  // ── URL param helpers ───────────────────────────────────────────
  function readParams() {
    const p = new URLSearchParams(location.search);
    return {
      limit: clamp(parseInt(p.get('limit') || '20', 10), 1, 100),
      n:     clamp(parseInt(p.get('n')     || '5',  10), 1, 5),
      sort:  p.get('sort')  || null,
      search: p.get('search') || '',
    };
  }

  function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }

  function pushParams() {
    const p = new URLSearchParams();
    if (st.limit !== 20)    p.set('limit',  st.limit);
    if (st.n !== 5)         p.set('n',      st.n);
    if (st.sort)            p.set('sort',   st.sort);
    if (st.search)          p.set('search', st.search);
    const qs = p.toString();
    history.replaceState(null, '', qs ? '?' + qs : location.pathname);
  }

  // ── State ───────────────────────────────────────────────────────
  const init = readParams();
  const st = {
    limit:      init.limit,
    n:          init.n,
    sort:       init.sort,
    sortDir:    defaultDir(init.sort),
    search:     init.search,
    events:     [],
    ts:         '—',
    ttl:        30,
    openTitles: new Set(),
    fetchedAt:  0,
  };

  function defaultDir(sort) {
    // volumes default to descending (-1), title/rank default to ascending (1)
    return (sort === 'volume' || sort === 'volume24h') ? -1 : 1;
  }

  // ── DOM refs ────────────────────────────────────────────────────
  const liveDot    = document.getElementById('liveDot');
  const liveLabel  = document.getElementById('liveLabel');
  const countdown  = document.getElementById('countdown');
  const headerTs   = document.getElementById('headerTs');
  const container  = document.getElementById('tableContainer');
  const emptyMsg   = document.getElementById('emptyMsg');
  const searchBox  = document.getElementById('searchBox');
  const limitSel   = document.getElementById('limitSel');
  const nGroup     = document.getElementById('nGroup');
  const exportBtn  = document.getElementById('exportBtn');
  const sortInfo   = document.getElementById('sortInfo');

  // ── Init controls to state ──────────────────────────────────────
  searchBox.value = st.search;
  limitSel.value  = String(st.limit);
  if (!limitSel.value) { limitSel.value = '20'; st.limit = 20; }
  syncSegBtns();

  function syncSegBtns() {
    nGroup.querySelectorAll('.seg-btn').forEach(b => {
      b.classList.toggle('active', parseInt(b.dataset.n, 10) === st.n);
    });
  }

  function syncSortInfo() {
    if (!st.sort) { sortInfo.style.display = 'none'; return; }
    const dir = st.sortDir === 1 ? '▲' : '▼';
    sortInfo.textContent = `sorted by ${st.sort} ${dir}`;
    sortInfo.style.display = '';
  }

  // ── Fetch + countdown ───────────────────────────────────────────
  let countdownTimer = null;

  function startCountdown() {
    if (countdownTimer) clearInterval(countdownTimer);
    countdownTimer = setInterval(() => {
      const elapsed = (Date.now() - st.fetchedAt) / 1000;
      const rem = Math.ceil(st.ttl - elapsed);
      if (rem <= 0) {
        countdown.textContent = 'refreshing…';
        clearInterval(countdownTimer);
        countdownTimer = null;
        fetchData();
      } else {
        countdown.textContent = `next: ${rem}s`;
      }
    }, 1000);
  }

  async function fetchData() {
    liveDot.className = 'live-dot';
    liveLabel.textContent = 'fetching…';
    try {
      const res = await fetch(`/api/events?limit=${st.limit}`);
      if (!res.ok) throw new Error(res.status);
      const data = await res.json();
      st.events    = data.events || [];
      st.ts        = data.ts || '—';
      st.ttl       = data.ttl || 30;
      st.fetchedAt = Date.now();
      headerTs.textContent = st.ts.replace('T', '  ').replace('Z', ' UTC');
      liveDot.className = 'live-dot active';
      liveLabel.textContent = 'live';
      render();
      startCountdown();
    } catch (e) {
      liveDot.className = 'live-dot';
      liveLabel.textContent = 'error — retrying…';
      countdown.textContent = '';
      setTimeout(fetchData, 10_000);
    }
  }

  // ── Sort / filter helpers ───────────────────────────────────────
  function sortedFiltered() {
    let evs = [...st.events];

    // Filter
    if (st.search) {
      const q = st.search.toLowerCase();
      evs = evs.filter(e => e.title.toLowerCase().includes(q));
    }

    // Sort
    if (st.sort) {
      evs.sort((a, b) => {
        let ka, kb;
        if (st.sort === 'title')     { ka = a.title.toLowerCase(); kb = b.title.toLowerCase(); }
        else if (st.sort === 'volume')   { ka = a.volumeRaw;   kb = b.volumeRaw; }
        else if (st.sort === 'volume24h') { ka = a.volume24hRaw; kb = b.volume24hRaw; }
        else                         { ka = a.rank; kb = b.rank; }
        const d = st.sortDir;
        return ka < kb ? -d : ka > kb ? d : 0;
      });
    }

    return evs;
  }

  // ── Render ──────────────────────────────────────────────────────
  function render() {
    const evs = sortedFiltered();
    syncSortInfo();

    if (!evs.length) {
      container.innerHTML = '<div class="empty">No events match.</div>';
      return;
    }

    const N = st.n;
    const totalCols = 4 + N * 3;

    // Sorted indicator helpers
    const si = (col) => {
      if (st.sort !== col) return '';
      return ' ' + (st.sortDir === 1 ? '▲' : '▼');
    };

    // Build thead
    let contHdr = '';
    for (let i = 1; i <= N; i++) {
      contHdr += `<th class="left" style="border-left:1px solid #222;padding-left:10px">#${i}</th>
                  <th>Prc¢</th><th>Δ24h</th>`;
    }

    const thead = `<thead><tr>
      <th class="left">#</th>
      <th class="left sortable${st.sort==='title'?' sorted':''}" data-sort="title">Event${si('title')}</th>
      <th class="sortable${st.sort==='volume'?' sorted':''}" data-sort="volume">Total${si('volume')}</th>
      <th class="sortable${st.sort==='volume24h'?' sorted':''}" data-sort="volume24h">24h${si('volume24h')}</th>
      ${contHdr}
    </tr></thead>`;

    // Build tbody rows
    let rows = '';
    for (const ev of evs) {
      const isOpen = st.openTitles.has(ev.title);
      const conts  = (ev.contenders || []).slice(0, N);
      while (conts.length < N) conts.push({ name: '', price: '', delta: { text: '', direction: 'flat' }, endDate: '' });

      let contCells = '';
      for (const c of conts) {
        const dir  = c.delta ? c.delta.direction : 'flat';
        const dtxt = c.delta ? esc(c.delta.text) : '';
        contCells += `<td class="cont-name">${esc(c.name)}</td>
                      <td class="cont-price">${esc(c.price)}</td>
                      <td class="cont-delta ${esc(dir)}">${dtxt}</td>`;
      }

      const openCls = isOpen ? ' open' : '';
      rows += `<tr class="data-row${openCls}" data-title="${esc(ev.title)}">
        <td class="rank">${ev.rank}</td>
        <td class="event-cell"><span class="expand-icon${openCls}">▶</span>${esc(ev.title)}</td>
        <td class="vol">${esc(ev.volume)}</td>
        <td class="vol24h">${esc(ev.volume24h)}</td>
        ${contCells}
      </tr>`;

      if (isOpen) {
        const allConts = ev.contenders || [];
        let cards = '';
        for (const c of allConts) {
          const dir  = c.delta ? c.delta.direction : 'flat';
          const dtxt = c.delta ? esc(c.delta.text) : '';
          cards += `<div class="detail-card">
            <span class="detail-card-name">${esc(c.name)}</span>
            <span class="detail-card-price">${esc(c.price)}</span>
            <span class="detail-card-delta ${esc(dir)}">${dtxt}</span>
          </div>`;
        }
        const endDate = ev.endDate || '?';
        const nOut    = ev.contenderCount || 0;
        rows += `<tr class="detail-row">
          <td colspan="${totalCols}">
            <div class="detail-content">
              <div class="detail-title">${esc(ev.title)}</div>
              <div class="detail-meta">Ends: ${esc(endDate)} · ${nOut} outcome${nOut !== 1 ? 's' : ''}</div>
              <div class="detail-contenders">${cards}</div>
            </div>
          </td>
        </tr>`;
      }
    }

    container.innerHTML = `<table>${thead}<tbody id="tbody">${rows}</tbody></table>`;
  }

  // ── Event delegation ────────────────────────────────────────────
  container.addEventListener('click', (e) => {
    // Sort on thead click
    const th = e.target.closest('thead th[data-sort]');
    if (th) {
      const col = th.dataset.sort;
      if (st.sort === col) {
        st.sortDir *= -1;
      } else {
        st.sort    = col;
        st.sortDir = defaultDir(col);
      }
      pushParams();
      render();
      return;
    }

    // Expand/collapse data row
    const tr = e.target.closest('tr.data-row');
    if (tr) {
      const title = tr.dataset.title;
      if (st.openTitles.has(title)) {
        st.openTitles.delete(title);
      } else {
        st.openTitles.add(title);
      }
      render();
    }
  });

  // ── Controls ────────────────────────────────────────────────────
  searchBox.addEventListener('input', () => {
    st.search = searchBox.value.trim();
    pushParams();
    render();
  });

  limitSel.addEventListener('change', () => {
    const newLimit = parseInt(limitSel.value, 10);
    if (newLimit !== st.limit) {
      st.limit = newLimit;
      st.openTitles.clear();
      pushParams();
      if (countdownTimer) { clearInterval(countdownTimer); countdownTimer = null; }
      countdown.textContent = '';
      fetchData();
    }
  });

  nGroup.addEventListener('click', (e) => {
    const btn = e.target.closest('.seg-btn');
    if (!btn) return;
    st.n = parseInt(btn.dataset.n, 10);
    syncSegBtns();
    pushParams();
    render();
  });

  exportBtn.addEventListener('click', () => {
    const evs = sortedFiltered();
    // Build header row
    const maxN = Math.max(...evs.map(e => (e.contenders || []).length), 0);
    let hdr = 'Rank,Title,Total Vol,24h Vol,End Date,Outcomes';
    for (let i = 1; i <= maxN; i++) hdr += `,C${i} Name,C${i} Price,C${i} Δ24h`;

    const csvRows = [hdr];
    for (const ev of evs) {
      let row = [
        ev.rank,
        `"${(ev.title || '').replace(/"/g, '""')}"`,
        ev.volume,
        ev.volume24h,
        ev.endDate || '',
        ev.contenderCount || 0,
      ];
      for (const c of (ev.contenders || [])) {
        row.push(
          `"${(c.name || '').replace(/"/g, '""')}"`,
          c.price || '',
          c.delta ? c.delta.text : '',
        );
      }
      csvRows.push(row.join(','));
    }

    const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = `polymarket-${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  });

  // ── Boot ────────────────────────────────────────────────────────
  fetchData();
</script>
</body>
</html>
